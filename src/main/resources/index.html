<!DOCTYPE html>
<html>

<head>
    <script data-require="jquery@*" data-semver="3.1.1" src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <style>
        
        H1 {

            float:left;
            position: absolute;
            height:50px;
        }
        #add-receipt {
            display: inline-block;
            background-color: #6699ff;
            width: 100px;
            font-size: 2em;
            color: white;
            text-align: center;
            cursor: pointer;
            border-radius: 2px;
            float:right;
            margin-top: 10px; 
            
        }
        .button{
            background-color:#55A;
            border: 1px solid #229;
            width: 100px;
            float: right;
            font-size: 2em;
            color: white;
            text-align: center;
        }
        #receiptList {
            position: absolute;
            top:100px;
            width: 100%;
        }
        .receipt {
            background-color: white;
            width: 100%;
        }

        .receiptTableHead {
            background-color: white;
            width: 100%;
        }

        .receipt span {
            width: 300px;
            display: inline-block;
            text-align: center;
            padding: 6px;
            margin: -1px;
        }

        .receiptTableHead span {
            width: 300px;
            font-weight: bold;
            display: inline-block;
            text-align: center;
            padding: 6px;
            margin: -1px;
        }

        .receiptTag {
            width: 2px;
            display: inline-block;
            text-align: center;
            font-weight: bold;
        }

        #receipt-form {
            position: absolute;
            top:60px;
            width: 100%;
            background: white;
            display: none;
        }
        #receipt-form input {
            width: 88%;
            
            border: 1px solid black;
            color: white;
            padding-left: 10px;
            font-size: 20px;
            height: 30px;
        }
        ::-webkit-input-placeholder {
            color: white;
            font-size: 20px;
        }
        
        #cancel-receipt {
            display: inline-block;
            background-color: #002266;
            border: 1px solid #002266;
            font-size: -1em;
            color: white;
            text-align: center;
            cursor: pointer;
            border-radius: 2px;
            width:80px;
        }
        #save-receipt {
            display: inline-block;
            background-color: #002266;
            border: 1px solid #002266;
            font-size: -1em;
            color: white;
            text-align: center;
            cursor: pointer;
            border-radius: 2px;
            width:80px;
        }
        .tagValue {
            background-color: #002266;
            border: 1px solid black;
            width: 100px;
            color:white;
            text-align: center;
            border-radius: 50px;
            cursor: pointer;
            margin-bottom: 5px;
        }
        .add-tag {
            background-color: #6699ff;
            border: 1px solid black;
            width: 100px;
            color: white;
            text-align: center;
            border-radius: 50px;
            cursor: pointer;
        }
        .tag_input {
            width: 150px;
            background: inherit;
            border: 1px solid black;
            margin-left: 8px;
            margin-bottom: 5px;
            margin-top: 5px;
        }

    </style>
    <script>
        // This is the idiomatic way to ensure that JQuery does not
        // execute until the page has loaded
        function toggleReceiptForm() {
            var ele = document.getElementById('receiptForm');
            if (ele.style.display === 'none') {
                ele.style.display = 'block';
            } else {
                ele.style.display = 'none';
            }
        }

        const api = ""//"http://ec2-54-209-250-89.compute-1.amazonaws.com:8080"; // <- do not need a root api URL if this page is served directly by the API
        const x = " x";

        $(function(){
            toggleReceiptForm();
            
            $.getJSON(api+"/receipts", function(receipts){
                for(var i=0; i < receipts.length; i++) {
                    var receipt = receipts[i];
                    updateReceipt(receipt);
                }
            })

            $(`<div class="receiptTableHead"><span>Time</span><span>Merchant</span><span>$</span><span>Tags</span></span>`)
                .appendTo($("#receiptList"));
        });


        function updateReceipt(receipt){
            
                    
                    var date = new Date(1970, 0, 1);
                    date.setSeconds(receipt.time); // specify value for SECONDS here
                    var result = date.toISOString().substr(11, 8);
                    var tagList = [];
                    if(receipt.tags){
                        console.log("Has Tags");
                        if (receipt.tags.length>0) {
                            console.log("# of Tags: "+receipt.tags.length)
                            var tagLength = receipt.tags.length;
                            for(var i=0; i < tagLength; i++) {
                                var tagId = randomTagId();
                                console.log(receipt.tags[i]);
                                tagList += `<span id="${tagId}" class="tagValue" onclick="removeTag(${receipt.id},${tagId});" value="${receipt.tags[i].slice(1,-1)}" style="width:200px;">${receipt.tags[i].slice(1,-1)}${x}
                            </span>`;

                            }
                            console.log(tagList);
                        }
                    }

                    var addId = randomTagId();
                    $(`<div class="receipt" id=${receipt.id}>
                        <span class="created">${result}</span>
                        <span class="merchant">${receipt.merchant}</span>
                        <span class="amount">${receipt.amount}</span>
                        <span class="receiptTag" style="width:2px;">${tagList}<span id=${addId} class ="add-tag" onclick="addTags(${receipt.id},${addId});" style="width:200px;">Add +
                        </span></span>`)
                        .appendTo($("#receiptList"));

        }
        
        function removeTag(id,tagId) {
            console.log("removing tags on second click");
            console.log(tagId);
            var tagName = $(tagId).attr('value');
            console.log("id:"+id+",tag:"+tagName);
            $.ajax({
                        type: 'PUT',
                        url: api + "/tags/{"+tagName+"}",
                        contentType: 'application/json',
                        data: JSON.stringify(id),
                        success: function(result){
                            console.log("Successfully removed tag");
                            tagId.remove();

                        },
                        error: function (jqXhr, textStatus, errorThrown) {
                            console.log(errorThrown);
                        }
                    });
        }

        function removeTagOnDuplicateEntry(id,previous){
            console.log("removing tags on duplicate entry");
            tagId = previous.id;
            tagName = $.trim(previous.textContent).slice(0,-2);
            console.log("id:"+id+",tag:"+tagName);
            console.log("" + "/tags/{"+tagName+"}");
            $.ajax({
                        type: 'PUT',
                        url: api + "/tags/{"+tagName+"}",
                        contentType: 'application/json',
                        data: JSON.stringify(id),
                        success: function(result){
                            console.log("Successfully removed duplicate tag");
                            previous.remove();

                        },
                        error: function (jqXhr, textStatus, errorThrown) {
                            console.log(errorThrown);
                        }
                    });
        }

        function addTags(id,addId){
                console.log("in add tags");
                var addTagId = $(addId).attr('id');
                console.log(id+" addId: "+addTagId);
                var duplicate = false;
                var input = $(`<input type='text' class="tag_input">`);
                input.insertBefore($('#'+addTagId));
                input.keypress(function(key) {
                    if (key.which === 13){
                        duplicate = false;
                        console.log("# of siblings:" +input.siblings().length);
                        for (var j = 0; j < input.siblings().length; j++) {
                                var previous = input.siblings()[j];
                                var previousName = $.trim(previous.textContent);
                                console.log("sibling trimmed name:"+ previousName + previousName.length);
                                if (input.val() === previousName.slice(0,-2)){
                                    console.log("duplicate is true");
                                    duplicate = true;
                                    input.remove();
                                    removeTagOnDuplicateEntry(id,previous);
                                }
                            }
                            if (!duplicate){
                                $.ajax({
                                    type: 'PUT',
                                    url: api + "/tags/{"+input.val()+"}",
                                    contentType: 'application/json',
                                    data: JSON.stringify(id),
                                    success: function(result){
                                        console.log(result);
                                        console.log("Tag added to receipt");
                                        var tagId = randomTagId();
                                        var tagName= input.val();
                                        console.log("randomTagId "+tagId);
                                        console.log(input.val());
                                        var newTag = $(`<span class="tagValue" onclick="removeTag(${id},${tagId});" id = "${tagId}" value="${tagName}" style="width:200px;">${tagName}${x}</span>`);
                                        console.log("Inserting Button");
                                        newTag.insertBefore(input);
                                        input.remove();

                                    },
                                    error: function (jqXhr, textStatus, errorThrown) {
                                        console.log(errorThrown);
                                    }
                                });
                            }
                    }
                });

               }

            
        

        function randomTagId(){
            return "a" +Math.random().toString(36).substr(2,10);
        }


        function saveReceipt(){
            console.log("save clicked");
            var data = {
                    merchant: $('#merchant').val(),
                    amount: $('#amount').val()
                };
                $.ajax({
                    url: api + "/receipts",
                    dataType: 'json',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(data),
                    success: function (receipt) {
                        console.log('saving receipts');
                        console.log(receipt);
                        updateReceipt(receipt);
                        $('#merchant').val('');
                        $('#amount').val('');
                        $('#receiptForm').hide();
                    },
                    error: function (jqXhr, textStatus, errorThrown) {
                        console.log(data);
                        console.log(errorThrown);
                    }
                });

        }

        function cancelReceipt(){
            $("#receiptForm").hide();
        }

        function loadReceiptForm(){
            $("#receiptForm").show();
        }
        

        
         

    </script>
</head>

<body>
<DIV id="container">
    <h1>My Receipts</h1>
    <div id="add-receipt" onclick="loadReceiptForm()">+</div>
    <div class="receiptForm" id="receiptForm">
        <input type = "text" placeholder="merchant" id="merchant">
        <input type = "text" placeholder="amount" id="amount">
        <div id="cancel-receipt" onclick="cancelReceipt()">Cancel</div>
        <div id="save-receipt" onclick="saveReceipt()">Save</div>
    </div>
    <div id="receiptList">
    </div>
</DIV>
</body>

</html>